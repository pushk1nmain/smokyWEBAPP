<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåê –¢–µ—Å—Ç API —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/config.js"></script>
</head>
<body style="font-family: Arial; padding: 20px; background: #f0f0f0;">
    <div id="main-info" style="background: blue; color: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h1>üåê –¢–µ—Å—Ç API –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏</h1>
        <p>–¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É API –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ nginx –ø—Ä–æ–∫—Å–∏</p>
    </div>
    
    <div id="config-info" style="margin-top: 20px; padding: 20px; background: #e6f3ff; border-radius: 10px;">
        <h2>‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</h2>
        <p id="config-details">–ó–∞–≥—Ä—É–∂–∞–µ–º...</p>
    </div>
    
    <div id="api-test" style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 10px;">
        <h2>üåê –¢–µ—Å—Ç API –∑–∞–ø—Ä–æ—Å–∞:</h2>
        <p id="api-result">–ì–æ—Ç–æ–≤–∏–º—Å—è –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ...</p>
        <button id="test-btn" style="padding: 10px 20px; font-size: 16px; margin-top: 10px;">
            üöÄ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API
        </button>
    </div>
    
    <script>
        console.log('üî• –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        const configDetails = document.getElementById('config-details');
        if (window.SmokyConfig) {
            configDetails.innerHTML = `
                ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞:<br>
                ‚Ä¢ Base URL: ${window.SmokyConfig.api.baseUrl}<br>
                ‚Ä¢ API Key: ${window.SmokyConfig.api.apiKey ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (' + window.SmokyConfig.api.apiKey.substring(0, 20) + '...)' : '–ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
            `;
        } else {
            configDetails.innerHTML = '‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞';
        }
        
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL
        function getUserIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const tgWebAppData = urlParams.get('tgWebAppData');
            
            if (tgWebAppData) {
                try {
                    const decodedData = decodeURIComponent(tgWebAppData);
                    const dataParams = new URLSearchParams(decodedData);
                    const userDataStr = dataParams.get('user');
                    
                    if (userDataStr) {
                        const user = JSON.parse(decodeURIComponent(userDataStr));
                        return user.id;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                }
            }
            
            return 7523324398; // Fallback –Ω–∞ –≤–∞—à ID
        }
        
        // –¢–µ—Å—Ç API –∑–∞–ø—Ä–æ—Å–∞
        function testApiRequest() {
            const resultElement = document.getElementById('api-result');
            const testBtn = document.getElementById('test-btn');
            const userId = getUserIdFromUrl();
            
            resultElement.innerHTML = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å...';
            testBtn.disabled = true;
            
            const apiUrl = window.SmokyConfig.api.baseUrl + '/user/' + userId;
            console.log('üåê –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫:', apiUrl);
            
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': window.SmokyConfig.api.apiKey
                }
            })
            .then(response => {
                console.log('üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response);
                resultElement.innerHTML = `
                    ‚úÖ –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω!<br>
                    ‚Ä¢ URL: ${apiUrl}<br>
                    ‚Ä¢ Status: ${response.status} ${response.statusText}<br>
                    ‚Ä¢ Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}
                `;
                
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .then(data => {
                console.log('üìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', data);
                resultElement.innerHTML += `<br><br>üìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
                document.getElementById('api-test').style.background = 'lightgreen';
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ API:', error);
                resultElement.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                document.getElementById('api-test').style.background = 'pink';
            })
            .finally(() => {
                testBtn.disabled = false;
            });
        }
        
        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∫ –∫–Ω–æ–ø–∫–µ
        document.getElementById('test-btn').addEventListener('click', testApiRequest);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(testApiRequest, 2000);
    </script>
</body>
</html>
