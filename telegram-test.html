<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmokyApp - Telegram Test</title>
    
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js" onerror="console.error('Telegram WebApp script –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω')"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-size: 14px;
        }
        
        .test-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-panel h3 {
            margin-top: 0;
            color: #333;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 500;
            display: inline-block;
            margin: 4px 8px 4px 0;
        }
        
        .status--ok { background: #d4edda; color: #155724; }
        .status--error { background: #f8d7da; color: #721c24; }
        .status--warning { background: #fff3cd; color: #856404; }
        .status--info { background: #d1ecf1; color: #0c5460; }
        
        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #666;
        }
        
        .info-value {
            color: #333;
            font-family: monospace;
        }
        
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="test-panel">
        <h3>üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Telegram WebApp</h3>
        
        <div class="info-row">
            <span class="info-label">Telegram API:</span>
            <span id="telegram-api-status" class="status status--error">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</span>
        </div>
        
        <div class="info-row">
            <span class="info-label">InitData:</span>
            <span id="init-data-status" class="status status--error">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</span>
        </div>
        
        <div class="info-row">
            <span class="info-label">TelegramManager:</span>
            <span id="telegram-manager-status" class="status status--error">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</span>
        </div>
        
        <div class="info-row">
            <span class="info-label">–°—Ä–µ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</span>
            <span id="environment-status" class="status status--info">–û–ø—Ä–µ–¥–µ–ª—è–µ–º...</span>
        </div>
        
        <div class="info-row">
            <span class="info-label">User Agent:</span>
            <span id="user-agent" class="info-value">-</span>
        </div>
        
        <div class="info-row">
            <span class="info-label">URL:</span>
            <span id="current-url" class="info-value">-</span>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn" onclick="runDiagnostics()">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
            <button class="btn" onclick="testTelegramManager()">üß© –¢–µ—Å—Ç TelegramManager</button>
            <button class="btn" onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
    </div>
    
    <div class="test-panel">
        <h3>üìä –õ–æ–≥–∏</h3>
        <div id="logs" class="log">–ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...\n</div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logsEl = document.getElementById('logs');
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logsEl.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
        function clearLogs() {
            document.getElementById('logs').textContent = '';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(elementId, text, status) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `status status--${status}`;
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        async function runDiagnostics() {
            log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('user-agent').textContent = navigator.userAgent;
            document.getElementById('current-url').textContent = window.location.href;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram API
            await checkTelegramAPI();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º TelegramManager
            await checkTelegramManager();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ä–µ–¥—É
            checkEnvironment();
            
            log('‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram API
        async function checkTelegramAPI() {
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp API...');
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ Telegram API
            let attempts = 0;
            const maxAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥
            
            while (!window.Telegram?.WebApp && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
                if (attempts % 10 === 0) {
                    log(`   –û–∂–∏–¥–∞–Ω–∏–µ Telegram API... ${attempts * 100}ms`);
                }
            }
            
            if (window.Telegram?.WebApp) {
                updateStatus('telegram-api-status', '–î–æ—Å—Ç—É–ø–µ–Ω', 'ok');
                log('‚úÖ Telegram WebApp API –Ω–∞–π–¥–µ–Ω');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º initData
                const initData = window.Telegram.WebApp.initData;
                if (initData && initData !== '') {
                    updateStatus('init-data-status', `–ï—Å—Ç—å (${initData.length} —Å–∏–º–≤–æ–ª–æ–≤)`, 'ok');
                    log(`‚úÖ InitData –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç: ${initData.substring(0, 50)}...`);
                } else {
                    updateStatus('init-data-status', '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'warning');
                    log('‚ö†Ô∏è InitData –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–æ–π');
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                log(`   –í–µ—Ä—Å–∏—è API –ø–æ–¥–¥–µ—Ä–∂–∫–∞: ${window.Telegram.WebApp.version || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
                log(`   ViewportHeight: ${window.Telegram.WebApp.viewportHeight}`);
                log(`   Platform: ${window.Telegram.WebApp.platform || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
                
            } else {
                updateStatus('telegram-api-status', '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                updateStatus('init-data-status', '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                log('‚ùå Telegram WebApp API –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ TelegramManager
        async function checkTelegramManager() {
            log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ TelegramManager...');
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ TelegramManager
            let attempts = 0;
            const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥
            
            while (!window.TelegramManager && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
                if (attempts % 10 === 0) {
                    log(`   –û–∂–∏–¥–∞–Ω–∏–µ TelegramManager... ${attempts * 100}ms`);
                }
            }
            
            if (window.TelegramManager) {
                updateStatus('telegram-manager-status', '–î–æ—Å—Ç—É–ø–µ–Ω', 'ok');
                log('‚úÖ TelegramManager –Ω–∞–π–¥–µ–Ω');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥—ã
                const methods = ['initialize', 'isReady', 'getUserData', 'showMainButton'];
                methods.forEach(method => {
                    const hasMethod = typeof window.TelegramManager[method] === 'function';
                    log(`   ${method}: ${hasMethod ? '‚úÖ' : '‚ùå'}`);
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (typeof window.TelegramManager.isReady === 'function') {
                    const isReady = window.TelegramManager.isReady();
                    log(`   –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${isReady ? '‚úÖ –≥–æ—Ç–æ–≤' : '‚ö†Ô∏è –Ω–µ –≥–æ—Ç–æ–≤'}`);
                }
                
            } else {
                updateStatus('telegram-manager-status', '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                log('‚ùå TelegramManager –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
                const telegramObjects = Object.keys(window).filter(key => 
                    key.toLowerCase().includes('telegram')
                );
                log(`   –î–æ—Å—Ç—É–ø–Ω—ã–µ Telegram –æ–±—ä–µ–∫—Ç—ã: ${telegramObjects.join(', ') || '–Ω–µ—Ç'}`);
            }
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        function checkEnvironment() {
            log('üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è...');
            
            const checks = {
                hasValidInitData: !!(window.Telegram?.WebApp?.initData && window.Telegram.WebApp.initData !== ''),
                hasTelegramUserAgent: navigator.userAgent.includes('Telegram'),
                hasTelegramInUrl: window.location.href.includes('telegram'),
                hasTelegramProxy: !!window.TelegramWebviewProxy,
                isInFrame: window.parent !== window,
                isLocalhost: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            };
            
            Object.entries(checks).forEach(([check, result]) => {
                log(`   ${check}: ${result ? '‚úÖ' : '‚ùå'}`);
            });
            
            const isInTelegram = checks.hasValidInitData || 
                               checks.hasTelegramUserAgent || 
                               checks.hasTelegramInUrl || 
                               checks.hasTelegramProxy || 
                               checks.isInFrame;
            
            if (checks.isLocalhost) {
                updateStatus('environment-status', 'Localhost (Dev)', 'warning');
                log('‚ö†Ô∏è –ó–∞–ø—É—â–µ–Ω–æ –Ω–∞ localhost - —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏');
            } else if (isInTelegram) {
                updateStatus('environment-status', 'Telegram WebApp', 'ok');
                log('‚úÖ –ó–∞–ø—É—â–µ–Ω–æ –≤ Telegram WebApp');
            } else {
                updateStatus('environment-status', '–û–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä', 'info');
                log('‚ÑπÔ∏è –ó–∞–ø—É—â–µ–Ω–æ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
            }
        }

        // –¢–µ—Å—Ç TelegramManager
        async function testTelegramManager() {
            log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TelegramManager...');
            
            if (!window.TelegramManager) {
                log('‚ùå TelegramManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }
            
            try {
                // –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                if (typeof window.TelegramManager.initialize === 'function') {
                    log('   –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
                    const result = await window.TelegramManager.initialize();
                    log(`   –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${result ? '‚úÖ' : '‚ùå'}`);
                }
                
                // –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (typeof window.TelegramManager.getUserData === 'function') {
                    const userData = window.TelegramManager.getUserData();
                    log(`   –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userData ? JSON.stringify(userData) : '–Ω–µ—Ç'}`);
                }
                
                // –¢–µ—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                if (typeof window.TelegramManager.isReady === 'function') {
                    const isReady = window.TelegramManager.isReady();
                    log(`   –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${isReady ? '‚úÖ' : '‚ùå'}`);
                }
                
                log('‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TelegramManager –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ TelegramManager: ${error.message}`);
            }
        }

        // –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            log('üì± –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            runDiagnostics();
        });

        // –ï—Å–ª–∏ DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        if (document.readyState !== 'loading') {
            log('üì± DOM —É–∂–µ –≥–æ—Ç–æ–≤, –∑–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            runDiagnostics();
        }
    </script>

    <!-- Core Scripts (–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏) -->
    <script src="js/utils.js" onerror="log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ utils.js')"></script>
    <script src="js/api.js" onerror="log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ api.js')"></script>
    <script src="js/telegram.js" onerror="log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ telegram.js')"></script>
    <script src="js/router.js" onerror="log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ router.js')"></script>
    <script src="js/app.js" onerror="log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ app.js')"></script>
</body>
</html>