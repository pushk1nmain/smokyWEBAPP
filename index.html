<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmokyApp - –ü—É—Ç—å –∫ —Å–≤–æ–±–æ–¥–µ –æ—Ç –∫—É—Ä–µ–Ω–∏—è</title>
    
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js" onerror="console.warn('Telegram WebApp script –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω')"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/components.css">
    
    <!-- Preload –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app" class="app">
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
        <div id="progress-bar" class="progress-bar">
            <div class="progress-bar__fill" id="progress-fill"></div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ -->
        <main id="screen-container" class="screen-container">
            <!-- –≠–∫—Ä–∞–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </main>
        
        <!-- Overlay –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="loading-spinner"></div>
            <p class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="notification-container" class="notification-container"></div>
    </div>

    <!-- Telegram –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏ —Å–∏—Å—Ç–µ–º–∞ –æ–∂–∏–¥–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
    <script>
        // –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
        window.SmokyAppLoader = {
            scriptsLoaded: {
                utils: false,
                api: false,
                telegram: false,
                router: false
            },
            
            // –û—Ç–º–µ—Ç–∫–∞ –æ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
            markScriptLoaded(scriptName) {
                this.scriptsLoaded[scriptName] = true;
                console.log(`üìú –°–∫—Ä–∏–ø—Ç ${scriptName}.js –∑–∞–≥—Ä—É–∂–µ–Ω`);
                this.checkAllScriptsLoaded();
            },
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
            checkAllScriptsLoaded() {
                const allLoaded = Object.values(this.scriptsLoaded).every(loaded => loaded);
                if (allLoaded) {
                    console.log('üìú –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
                    this.startApp();
                }
            },
            
            // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
            async startApp() {
                try {
                    if (window.SmokyApp?.manualInitialize) {
                        await window.SmokyApp.manualInitialize();
                    } else if (window.SmokyApp?.initialize) {
                        console.log('üöÄ –ó–∞–ø—É—Å–∫ SmokyApp (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)...');
                        await window.SmokyApp.initialize();
                        console.log('üöÄ SmokyApp –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    } else {
                        console.error('üí• SmokyApp –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤');
                        console.error('   –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã SmokyApp:', Object.keys(window.SmokyApp || {}));
                    }
                } catch (error) {
                    console.error('üí• –§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', error);
                    console.error('üí• Stack trace:', error.stack);
                }
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Telegram WebApp
        if (window.Telegram?.WebApp) {
            console.log('üîÑ Telegram WebApp –≥–æ—Ç–æ–≤ –∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
            window.Telegram.WebApp.ready();
        } else {
            console.warn('‚ö†Ô∏è Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–∂–∏–¥–∞–Ω–∏—è TelegramManager
        function waitForTelegramManager() {
            return new Promise((resolve) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±—ä–µ–∫—Ç, –∏ —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
                if (window.TelegramManager && window.TelegramManagerLoaded) {
                    console.log('‚úÖ TelegramManager –¥–æ—Å—Ç—É–ø–µ–Ω —Å—Ä–∞–∑—É');
                    resolve(true);
                    return;
                }
                
                console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ TelegramManager...');
                let attempts = 0;
                const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥ (—É–≤–µ–ª–∏—á–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è)
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 10 –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                    if (attempts % 10 === 0) {
                        console.log(`   –ü–æ–ø—ã—Ç–∫–∞ ${attempts}: TelegramManager=${!!window.TelegramManager}, —Ñ–ª–∞–≥=${!!window.TelegramManagerLoaded}`);
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–∂–¥—ã–µ 30 –ø–æ–ø—ã—Ç–æ–∫
                        if (attempts % 30 === 0) {
                            console.log('   –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:', {
                                telegramScriptLoaded: window.SmokyAppLoader?.scriptsLoaded?.telegram,
                                documentReady: document.readyState,
                                windowKeys: Object.keys(window).filter(k => k.includes('Telegram')),
                                hasWindow: !!window
                            });
                        }
                    }
                    
                    if (window.TelegramManager && window.TelegramManagerLoaded) {
                        console.log(`‚úÖ TelegramManager –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ ${attempts * 100}ms`);
                        clearInterval(checkInterval);
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        console.error('‚ùå TelegramManager –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ 10 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è');
                        console.error('   –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:', {
                            hasTelegramManager: !!window.TelegramManager,
                            hasTelegramManagerLoaded: !!window.TelegramManagerLoaded,
                            scriptsLoadedState: window.SmokyAppLoader?.scriptsLoaded,
                            hasWindow: !!window,
                            documentReady: document.readyState
                        });
                        clearInterval(checkInterval);
                        resolve(false);
                    }
                }, 100);
            });
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π
        window.waitForTelegramManager = waitForTelegramManager;
    </script>
    
    <!-- Core Scripts —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <script src="js/utils.js" onload="window.SmokyAppLoader.markScriptLoaded('utils')" onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ utils.js')"></script>
    <script src="js/api.js" onload="window.SmokyAppLoader.markScriptLoaded('api')" onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ api.js')"></script>
    <script src="js/telegram.js" onload="window.SmokyAppLoader.markScriptLoaded('telegram')" onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ telegram.js')"></script>
    <script src="js/router.js" onload="window.SmokyAppLoader.markScriptLoaded('router')" onerror="console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ router.js')"></script>
</body>
</html>
