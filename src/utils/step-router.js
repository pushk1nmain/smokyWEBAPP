/**
 * SmokyApp - Step Router
 * –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à–∞–≥–∞–º–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫–æ–π —ç–∫—Ä–∞–Ω –ø–æ–∫–∞–∑–∞—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
 */

class StepRouter {
    constructor() {
        this.currentStep = null;
        this.telegramId = null;
        this.isInitialized = false;
        
        this.init();
    }

    /**
     * –ú–∞–ø–ø–∏–Ω–≥ —à–∞–≥–æ–≤ –∫ —ç–∫—Ä–∞–Ω–∞–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
     * –ö–∞–∂–¥—ã–π —à–∞–≥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É —ç–∫—Ä–∞–Ω—É
     */
    static STEP_TO_SCREEN = {
        1: 'src/pages/welcome/index.html',           // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –°–º–æ–∫–∏
        2: 'src/pages/name-input/index.html',        // –í–≤–æ–¥ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        3: 'src/pages/city-input/index.html',        // –í–≤–æ–¥ –≥–æ—Ä–æ–¥–∞ –∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        4: 'src/pages/how-did-you-know/index.html',  // –ò—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
        5: 'src/pages/waking-up/index.html',         // –≠–∫—Ä–∞–Ω –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è (–Ω–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏)
        // –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –Ω–æ–≤—ã–µ —ç–∫—Ä–∞–Ω—ã –ø–æ –º–µ—Ä–µ —Ä–∞–∑–≤–∏—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    };

    /**
     * –ù–∞–∑–≤–∞–Ω–∏—è —à–∞–≥–æ–≤ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏
     */
    static STEP_NAMES = {
        1: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ',
        2: '–í–≤–æ–¥ –∏–º–µ–Ω–∏',
        3: '–í–≤–æ–¥ –≥–æ—Ä–æ–¥–∞', 
        4: '–ò—Å—Ç–æ—á–Ω–∏–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
        5: '–ù–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏',
    };

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–∞
     * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp
     */
    async init() {
        try {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram WebApp –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                
                // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                const user = window.Telegram.WebApp.initDataUnsafe?.user;
                if (user?.id) {
                    this.telegramId = user.id;
                    console.log(`üîß StepRouter –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${this.telegramId}`);
                } else {
                    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            }
            
            this.isInitialized = true;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ StepRouter:', error);
            this.isInitialized = true; // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —à–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
     * @returns {Promise<number>} –¢–µ–∫—É—â–∏–π —à–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    async getCurrentStep() {
        if (!this.telegramId) {
            console.warn('‚ö†Ô∏è Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞');
            return 1;
        }

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.APIClient) {
                console.warn('‚ö†Ô∏è API –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞');
                return 1;
            }

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userData = await window.APIClient.getUser(this.telegramId);
            
            if (userData && typeof userData.progress_step === 'number') {
                let userStep = userData.progress_step;
                const maxStep = this.getMaxStep();
                
                // –ï—Å–ª–∏ —à–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π
                if (userStep > maxStep) {
                    console.warn(`‚ö†Ô∏è –®–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (${userStep}) –±–æ–ª—å—à–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ (${maxStep}). –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —à–∞–≥.`);
                    userStep = maxStep;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ
                    try {
                        await this.updateStep(maxStep);
                        console.log(`‚úÖ –®–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –¥–æ ${maxStep}`);
                    } catch (updateError) {
                        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —à–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', updateError);
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —à–∞–≥ –Ω–µ –º–µ–Ω—å—à–µ 1
                if (userStep < 1) {
                    console.warn(`‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —à–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (${userStep}). –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —à–∞–≥.`);
                    userStep = 1;
                }
                
                this.currentStep = userStep;
                console.log(`üìç –¢–µ–∫—É—â–∏–π —à–∞–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${this.currentStep} (${StepRouter.STEP_NAMES[this.currentStep] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'})`);
                return this.currentStep;
            } else {
                // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
                console.log('üëã –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞');
                return 1;
            }
            
        } catch (error) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (404) –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ - –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
            if (error.message?.includes('404') || error.message?.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω')) {
                console.log('üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞');
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞:', error);
            }
            return 1;
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —à–∞–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
     * @param {number} newStep –ù–æ–≤—ã–π —à–∞–≥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     * @returns {Promise<boolean>} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏
     */
    async updateStep(newStep) {
        if (!this.telegramId) {
            console.warn('‚ö†Ô∏è –ù–µ –º–æ–∂–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —à–∞–≥: Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return false;
        }

        if (!Number.isInteger(newStep) || newStep < 1) {
            console.error('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —à–∞–≥–∞:', newStep);
            return false;
        }

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.APIClient) {
                console.warn('‚ö†Ô∏è API –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–µ –º–æ–∂–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —à–∞–≥');
                return false;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const result = await window.APIClient.updateProgressStep(this.telegramId, newStep);
            
            if (result.success) {
                this.currentStep = newStep;
                console.log(`‚úÖ –®–∞–≥ –æ–±–Ω–æ–≤–ª–µ–Ω: ${newStep} (${StepRouter.STEP_NAMES[newStep] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'})`);
                return true;
            } else {
                console.error('‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —à–∞–≥–∞:', result);
                return false;
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —à–∞–≥–∞:', error);
            return false;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç URL —ç–∫—Ä–∞–Ω–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —à–∞–≥–∞
     * @param {number} step –ù–æ–º–µ—Ä —à–∞–≥–∞
     * @returns {string|null} URL —ç–∫—Ä–∞–Ω–∞ –∏–ª–∏ null –µ—Å–ª–∏ —à–∞–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω
     */
    getScreenForStep(step) {
        const screenPath = StepRouter.STEP_TO_SCREEN[step];
        if (!screenPath) {
            console.error(`‚ùå –≠–∫—Ä–∞–Ω –¥–ª—è —à–∞–≥–∞ ${step} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            return null;
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
        return `/${screenPath}`;
    }

    /**
     * –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —ç–∫—Ä–∞–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –µ–≥–æ —Ç–µ–∫—É—â–µ–º—É —à–∞–≥—É
     * @param {boolean} force –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —É–∂–µ –Ω–∞ –Ω—É–∂–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
     */
    async navigateToCurrentStep(force = false) {
        try {
            // –î–æ–∂–∏–¥–∞–µ–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            if (!this.isInitialized) {
                await this.init();
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —à–∞–≥
            const currentStep = await this.getCurrentStep();
            const targetUrl = this.getScreenForStep(currentStep);
            
            if (!targetUrl) {
                console.error(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —ç–∫—Ä–∞–Ω –¥–ª—è —à–∞–≥–∞ ${currentStep}`);
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø–µ—Ä–≤—ã–π —à–∞–≥ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                const fallbackUrl = this.getScreenForStep(1);
                if (fallbackUrl) {
                    window.location.href = fallbackUrl;
                }
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã —É–∂–µ –Ω–∞ –Ω—É–∂–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
            const currentPath = window.location.pathname;
            const targetPath = targetUrl;
            
            if (!force && (currentPath === targetPath || currentPath.endsWith(targetPath))) {
                console.log(`üìç –£–∂–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –¥–ª—è —à–∞–≥–∞ ${currentStep}`);
                return;
            }

            // –í—ã–ø–æ–ª–Ω—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            console.log(`üöÄ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à–∞–≥ ${currentStep}: ${targetUrl}`);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º LoadingManager –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
            if (window.LoadingManager?.navigateWithTransition) {
                window.LoadingManager.navigateWithTransition(targetUrl);
            } else {
                window.location.href = targetUrl;
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ —Ç–µ–∫—É—â–µ–º—É —à–∞–≥—É:', error);
            
            // –í —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø–µ—Ä–≤—ã–π —ç–∫—Ä–∞–Ω
            const fallbackUrl = this.getScreenForStep(1);
            if (fallbackUrl) {
                window.location.href = fallbackUrl;
            }
        }
    }

    /**
     * –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç–∫—Ä–∞–Ω
     * @returns {Promise<boolean>} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞
     */
    async goToNextStep() {
        try {
            const currentStep = this.currentStep || await this.getCurrentStep();
            const nextStep = currentStep + 1;
            const maxStep = this.getMaxStep();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
            if (nextStep > maxStep) {
                console.warn(`‚ö†Ô∏è –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ${nextStep} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —à–∞–≥ ${maxStep}. –û—Å—Ç–∞–µ–º—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–º —à–∞–≥–µ.`);
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
            const nextScreenUrl = this.getScreenForStep(nextStep);
            if (!nextScreenUrl) {
                console.warn(`‚ö†Ô∏è –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ${nextStep} –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω`);
                return false;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const updateSuccess = await this.updateStep(nextStep);
            if (!updateSuccess) {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —à–∞–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
                return false;
            }

            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç–∫—Ä–∞–Ω
            console.log(`‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É ${nextStep}: ${nextScreenUrl}`);
            
            if (window.LoadingManager?.navigateWithTransition) {
                window.LoadingManager.navigateWithTransition(nextScreenUrl);
            } else {
                window.location.href = nextScreenUrl;
            }
            
            return true;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É:', error);
            return false;
        }
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —à–∞–≥—É
     * @returns {Promise<boolean>} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞
     */
    async goToPreviousStep() {
        try {
            const currentStep = this.currentStep || await this.getCurrentStep();
            const previousStep = currentStep - 1;
            
            if (previousStep < 1) {
                console.warn('‚ö†Ô∏è –ù–µ–ª—å–∑—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥ —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞');
                return false;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
            const previousScreenUrl = this.getScreenForStep(previousStep);
            if (!previousScreenUrl) {
                console.error(`‚ùå –ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥ ${previousStep} –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω`);
                return false;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const updateSuccess = await this.updateStep(previousStep);
            if (!updateSuccess) {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —à–∞–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
                return false;
            }

            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω
            console.log(`‚¨ÖÔ∏è –í–æ–∑–≤—Ä–∞—Ç –∫ —à–∞–≥—É ${previousStep}: ${previousScreenUrl}`);
            
            if (window.LoadingManager?.navigateWithTransition) {
                window.LoadingManager.navigateWithTransition(previousScreenUrl);
            } else {
                window.location.href = previousScreenUrl;
            }
            
            return true;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —à–∞–≥—É:', error);
            return false;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–æ—É—Ç–µ—Ä–∞
     * @returns {Object} –û–±—ä–µ–∫—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
     */
    getState() {
        return {
            isInitialized: this.isInitialized,
            telegramId: this.telegramId,
            currentStep: this.currentStep,
            currentStepName: StepRouter.STEP_NAMES[this.currentStep] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π',
            totalSteps: Object.keys(StepRouter.STEP_TO_SCREEN).length,
            availableSteps: Object.keys(StepRouter.STEP_TO_SCREEN).map(Number)
        };
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —à–∞–≥
     * @returns {number} –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —à–∞–≥–∞
     */
    getMaxStep() {
        const steps = Object.keys(StepRouter.STEP_TO_SCREEN).map(Number);
        return Math.max(...steps);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —à–∞–≥ –≤–∞–ª–∏–¥–Ω—ã–º
     * @param {number} step –ù–æ–º–µ—Ä —à–∞–≥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
     * @returns {boolean} True –µ—Å–ª–∏ —à–∞–≥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
     */
    isValidStep(step) {
        return Number.isInteger(step) && step >= 1 && StepRouter.STEP_TO_SCREEN.hasOwnProperty(step);
    }
}

// –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Ä–æ—É—Ç–µ—Ä–∞
window.StepRouter = new StepRouter();

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = StepRouter;
}

console.log('üîß StepRouter –∑–∞–≥—Ä—É–∂–µ–Ω');